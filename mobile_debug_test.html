<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Debug Test - Tedara Storefront</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-panel {
            background: #dc2626;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .success {
            background: #10b981;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #ef4444;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            background: #3b82f6;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #10b981; color: white; }
        .status.error { background: #ef4444; color: white; }
        .status.warning { background: #f59e0b; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Mobile Debug Test - Tedara Storefront</h1>
        
        <!-- Mobile Debug Panel -->
        <div class="debug-panel" id="mobile-debug-panel">
            <strong>üì± Mobile Debug Panel</strong><br>
            <span id="debug-info">Loading...</span>
        </div>

        <!-- Test Results -->
        <div id="test-results">
            <div class="info">
                <h2>üîç Running Mobile Debug Tests...</h2>
                <p>This test will help identify why the mobile storefront is showing "Store Not Found" error.</p>
            </div>
        </div>

        <!-- Test Buttons -->
        <div class="test-section">
            <h3>üß™ Manual Tests</h3>
            <button onclick="testAPI()">Test API Endpoint</button>
            <button onclick="testSSL()">Test SSL/HTTPS</button>
            <button onclick="testTenantDetection()">Test Tenant Detection</button>
            <button onclick="testMobileFeatures()">Test Mobile Features</button>
            <button onclick="clearCache()">Clear Cache & Reload</button>
        </div>

        <!-- Results Display -->
        <div id="results" class="test-section">
            <h3>üìä Test Results</h3>
            <div id="results-content">Click a test button above to see results...</div>
        </div>
    </div>

    <script>
        // Mobile Detection
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Update Debug Panel
        function updateDebugPanel() {
            const pathSegments = window.location.pathname.split('/').filter(Boolean);
            const tenant = pathSegments[0] || 'NOT DETECTED';
            const isMobileDevice = isMobile();
            
            document.getElementById('debug-info').innerHTML = `
                <strong>Tenant:</strong> ${tenant} | 
                <strong>Device:</strong> ${isMobileDevice ? 'Mobile' : 'Desktop'} | 
                <strong>URL:</strong> ${window.location.href} | 
                <strong>Time:</strong> ${new Date().toLocaleTimeString()}
            `;
        }

        // Test API Endpoint (tries both /backend/public/api and /api)
        async function testAPI() {
            const resultsDiv = document.getElementById('results-content');
            resultsDiv.innerHTML = '<div class="info">üîÑ Testing API endpoint...</div>';
            
            const qsTenant = new URLSearchParams(window.location.search).get('tenant');
            const defaultTenant = 'fanoos';
            const tenant = (qsTenant && qsTenant.trim()) ? qsTenant.trim() : defaultTenant;
            
            const candidates = [
                `http://api.tedara.com/backend/public/api/storefront/${tenant}/theme`,
                `https://api.tedara.com/backend/public/api/storefront/${tenant}/theme`,
                `http://api.tedara.com/api/storefront/${tenant}/theme`,
                `https://api.tedara.com/api/storefront/${tenant}/theme`
            ];
            
            let logs = [];
            for (const url of candidates) {
                try {
                    const startedAt = Date.now();
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        redirect: 'follow' // Follow redirects
                    });
                    const elapsed = Date.now() - startedAt;
                    const text = await response.text();
                    const finalUrl = response.url; // This shows the final URL after redirects
                    logs.push({ 
                        originalUrl: url, 
                        finalUrl: finalUrl, 
                        redirected: url !== finalUrl,
                        status: response.status, 
                        ok: response.ok, 
                        elapsedMs: elapsed, 
                        bodyPreview: text.slice(0, 500) 
                    });
                    if (response.ok) {
                        const data = JSON.parse(text);
                        resultsDiv.innerHTML = `
                            <div class="success">
                                <h4>‚úÖ API Test Successful</h4>
                                <p><strong>Original URL:</strong> ${url}</p>
                                <p><strong>Final URL:</strong> ${finalUrl}</p>
                                <p><strong>Redirected:</strong> ${url !== finalUrl ? 'YES' : 'NO'}</p>
                                <p><strong>HTTP Code:</strong> ${response.status}</p>
                                <p><strong>Store Name:</strong> ${data.meta?.store?.name || 'N/A'}</p>
                                <p><strong>Store Description:</strong> ${data.meta?.store?.description || 'N/A'}</p>
                                <p><strong>Elapsed:</strong> ${elapsed} ms</p>
                            </div>
                            <details>
                                <summary>View Debug Log</summary>
                                <pre>${JSON.stringify(logs, null, 2)}</pre>
                            </details>
                        `;
                        return;
                    }
                } catch (err) {
                    logs.push({ 
                        originalUrl: url, 
                        error: err?.message || String(err),
                        errorType: err?.name || 'Unknown'
                    });
                }
            }
            
            resultsDiv.innerHTML = `
                <div class="error">
                    <h4>‚ùå API Test Error</h4>
                    <p><strong>Tried URLs:</strong></p>
                    <pre>${candidates.map(u => `- ${u}`).join('\n')}</pre>
                    <p>All attempts failed. See debug log below.</p>
                </div>
                <details open>
                    <summary>Debug Log</summary>
                    <pre>${JSON.stringify(logs, null, 2)}</pre>
                </details>
            `;
        }

        // Test Tenant Detection
        function testTenantDetection() {
            const resultsDiv = document.getElementById('results-content');
            const pathSegments = window.location.pathname.split('/').filter(Boolean);
            const tenant = pathSegments[0] || 'NOT DETECTED';
            const isMobileDevice = isMobile();
            
            resultsDiv.innerHTML = `
                <div class="info">
                    <h4>üîç Tenant Detection Test</h4>
                    <p><strong>Detected Tenant:</strong> <span class="status ${tenant !== 'NOT DETECTED' ? 'success' : 'error'}">${tenant}</span></p>
                    <p><strong>URL Pathname:</strong> ${window.location.pathname}</p>
                    <p><strong>Path Segments:</strong> [${pathSegments.join(', ')}]</p>
                    <p><strong>Device Type:</strong> <span class="status ${isMobileDevice ? 'success' : 'warning'}">${isMobileDevice ? 'Mobile' : 'Desktop'}</span></p>
                    <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                </div>
            `;
        }

        // Test SSL/HTTPS
        async function testSSL() {
            const resultsDiv = document.getElementById('results-content');
            resultsDiv.innerHTML = '<div class="info">üîÑ Testing SSL/HTTPS...</div>';
            
            const tests = [
                { name: 'HTTP API Test', url: 'http://api.tedara.com/backend/public/api/test' },
                { name: 'HTTPS API Test', url: 'https://api.tedara.com/backend/public/api/test' },
                { name: 'HTTP CORS Test', url: 'http://api.tedara.com/backend/public/cors-test.php' },
                { name: 'HTTPS CORS Test', url: 'https://api.tedara.com/backend/public/cors-test.php' }
            ];
            
            let results = [];
            for (const test of tests) {
                try {
                    const start = Date.now();
                    const response = await fetch(test.url, { 
                        method: 'GET',
                        redirect: 'follow'
                    });
                    const elapsed = Date.now() - start;
                    const text = await response.text();
                    results.push({
                        name: test.name,
                        originalUrl: test.url,
                        finalUrl: response.url,
                        redirected: test.url !== response.url,
                        status: response.status,
                        ok: response.ok,
                        elapsed: elapsed,
                        success: true,
                        error: null
                    });
                } catch (error) {
                    results.push({
                        name: test.name,
                        originalUrl: test.url,
                        success: false,
                        error: error.message,
                        errorType: error.name
                    });
                }
            }
            
            let html = '<div class="info"><h4>üîí SSL/HTTPS Test Results</h4>';
            results.forEach(result => {
                const statusClass = result.success && result.ok ? 'success' : 'error';
                html += `<p><strong>${result.name}:</strong> <span class="status ${statusClass}">${result.success ? (result.ok ? 'SUCCESS' : `FAILED (${result.status})`) : 'ERROR'}</span></p>`;
                if (result.error) {
                    html += `<p style="font-size: 12px; color: #666;">Error: ${result.error}</p>`;
                }
            });
            html += '</div><details><summary>Full Results</summary><pre>' + JSON.stringify(results, null, 2) + '</pre></details>';
            resultsDiv.innerHTML = html;
        }

        // Test Mobile Features
        function testMobileFeatures() {
            const resultsDiv = document.getElementById('results-content');
            const isMobileDevice = isMobile();
            const hasTouch = 'ontouchstart' in window;
            const screenWidth = window.screen.width;
            const screenHeight = window.screen.height;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            resultsDiv.innerHTML = `
                <div class="info">
                    <h4>üì± Mobile Features Test</h4>
                    <p><strong>Mobile Detection:</strong> <span class="status ${isMobileDevice ? 'success' : 'error'}">${isMobileDevice ? 'Mobile' : 'Desktop'}</span></p>
                    <p><strong>Touch Support:</strong> <span class="status ${hasTouch ? 'success' : 'error'}">${hasTouch ? 'Yes' : 'No'}</span></p>
                    <p><strong>Screen Size:</strong> ${screenWidth}x${screenHeight}</p>
                    <p><strong>Viewport Size:</strong> ${viewportWidth}x${viewportHeight}</p>
                    <p><strong>Device Pixel Ratio:</strong> ${window.devicePixelRatio}</p>
                    <p><strong>Orientation:</strong> ${screenWidth > screenHeight ? 'Landscape' : 'Portrait'}</p>
                </div>
            `;
        }

        // Clear Cache and Reload
        function clearCache() {
            const resultsDiv = document.getElementById('results-content');
            resultsDiv.innerHTML = '<div class="info">üîÑ Clearing cache and reloading...</div>';
            
            // Clear various caches
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // Reload with cache busting
            setTimeout(() => {
                window.location.href = window.location.href + '?v=' + Date.now();
            }, 1000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDebugPanel();
            
            // Auto-run basic tests
            setTimeout(() => {
                testTenantDetection();
            }, 500);
            
            // Update debug panel every 5 seconds
            setInterval(updateDebugPanel, 5000);
        });

        // Log to console for debugging
        console.log('üì± Mobile Debug Test Loaded');
        console.log('Device Info:', {
            isMobile: isMobile(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            pathname: window.location.pathname
        });
    </script>
</body>
</html>
